name: Sync CHANGELOG to README

on:
  push:
    paths:
      - 'CHANGELOG.md'
      - 'CHANGELOG_zh.md'
    branches:
      - main
  workflow_dispatch:

jobs:
  sync-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update README files
        run: |
          python3 << 'EOF'
          import re

          # Read CHANGELOG files directly
          with open('CHANGELOG.md', 'r', encoding='utf-8') as f:
              changelog_en = f.read()

          with open('CHANGELOG_zh.md', 'r', encoding='utf-8') as f:
              changelog_zh = f.read()

          # Update README.md
          with open('README.md', 'r', encoding='utf-8') as f:
              content_en = f.read()

          pattern_en = r'## Changelog\n\nFor detailed version history and changes, please refer to \[CHANGELOG\.md\]\(CHANGELOG\.md\)\.'
          replacement_en = f'## Changelog\n\n{changelog_en}'
          new_content_en = re.sub(pattern_en, replacement_en, content_en)

          with open('README.md', 'w', encoding='utf-8') as f:
              f.write(new_content_en)

          # Update README_zh.md
          with open('README_zh.md', 'r', encoding='utf-8') as f:
              content_zh = f.read()

          pattern_zh = r'## 更新日志\n\n详细的版本历史和变更记录，请参考 \[CHANGELOG_zh\.md\]\(CHANGELOG_zh\.md\)\。'
          replacement_zh = f'## 更新日志\n\n{changelog_zh}'
          new_content_zh = re.sub(pattern_zh, replacement_zh, content_zh)

          with open('README_zh.md', 'w', encoding='utf-8') as f:
              f.write(new_content_zh)
          EOF

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md README_zh.md
          git diff --staged --quiet || git commit -m "chore: sync CHANGELOG to README files [skip ci]"

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main
